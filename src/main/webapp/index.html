<!doctype html>
<html>
<head>
<title>ER Diagram</title>

<link href="/js/vis/vis.css" rel="stylesheet" type="text/css" />
<link href="/js/bootstrap/css/bootstrap.min.css" rel="stylesheet"
	type="text/css" />
</head>

<body>
	<div class="container">
		<form id="dsInfoId" role="form">
			<div class="row">
				<div class="col-sm-5">
					<div class="form-group">
						<label for="url">URL:</label> <input type="text"
							class="form-control" id="url"
							value="jdbc:oracle:thin:@[hostname]:[port]:[sid]">
					</div>
					<div class="form-group">
						<label for="username">Username:</label> <input type="text"
							class="form-control" id="username" value="">
					</div>
					<div class="form-group">
						<label for="password">Password:</label> <input type="password"
							class="form-control" id="password" value="">
					</div>
					<div class="form-group">
						<label for="schema">Schema:</label> <input type="text"
							class="form-control" id="schema" value="dragon">
					</div>
					<div class="form-group">
						<label for="schema">Force Refresh:</label> <label
							class="radio-inline"><input type="radio"
							name="forceRefresh" value="true">True</label> <label
							class="radio-inline"><input type="radio"
							name="forceRefresh" value="false" checked>False</label>
					</div>
				</div>
			</div>
			<div class="row">
				<div class="col-sm-5">
					<div class="form-group">
						<button type="button" class="btn btn-primary generateDiagram">Generate
							Diagram</button>
					</div>
				</div>
			</div>
		</form>
	</div>

	<hr />

	<div id="network"></div>

	<script type="text/javascript" src="/js/jquery-1.11.3.min.js"></script>
	<script type="text/javascript" src="/js/bootstrap/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="/js/lodash/lodash.js"></script>
	<script type="text/javascript" src="/js/bootstrap-notify/bootstrap-notify.min.js"></script>
	<script type="text/javascript" src="/js/backbone/backbone-min.js"></script>
	<script type="text/javascript" src="/js/vis/vis.js"></script>
	<script type="text/javascript" src="/js/vis-highlight.js"></script>

	<script type="text/javascript">
		var DsInputView = Backbone.View
				.extend({
					el : $("#dsInfoId"),
					events : {
						'click .generateDiagram' : 'generateDiagram'
					},
					generateDiagram : function() {
						var postData = {
							"url" : $("#url").val(),
							"username" : $("#username").val(),
							"password" : $("#password").val(),
							"schema" : $("#schema").val(),
							"forceRefresh" : $(
									"input:radio[name=forceRefresh]:checked")
									.val()
						};

						var that = this;
						var jsonData;
						$.ajax({
							async : false,
							type : "POST",
							url : "/rest/erDiagram",
							contentType : "application/json; charset=utf-8",
							dataType : "json",
							data : JSON.stringify(postData),
							beforeSend : function() {
							},
							error : function(e) {
								alert("Error trying to retrieve data. " + e);
							},
							success : function(json) {
								jsonData = json;
							},
							complete : function() {
								that.$el.hide();
							},
						});

						if (jsonData) {
							// create an array with nodes
							nodes = new vis.DataSet(jsonData.nodes);
							edges = new vis.DataSet(jsonData.edges);

							var data = {
								nodes : nodes,
								edges : edges
							};
							var options = {
								configure : true,
								width : window.innerWidth,
								height : window.innerHeight,
								layout : {
									randomSeed : 8
								},
								interaction : {
									multiselect : true,
									navigationButtons : true
								},
								nodes : {
									borderWidthSelected : 2,
									shape : 'box'
								},
								edges : {
									arrows : {
										to : {
											scaleFactor : 0.5
										}
									},
									font : {
										align : "middle"
									},
									smooth : {
										type : 'continuous'
									},
									length : 400
								}
							};
							network = new vis.Network(container[0], data, options);
							
							canvas = network.canvas.frame.canvas;
							ctx = canvas.getContext('2d');
						}
					}
				});
		
		function removeSelectedNodes() {
			var selectedNodeIds = network.getSelectedNodes();
			nodes.remove(selectedNodeIds);
			$.notify({
				message: selectedNodeIds.length + " nodes removed." 
			},{
				type: 'success'
			});
		}
		
		function registerListeners() {
			document.body.oncontextmenu = function() {return false;};

			container.on("mousemove", function(e) {
				if (drag) { 
					restoreDrawingSurface();
					rect.w = (e.pageX - this.offsetLeft) - rect.startX;
					rect.h = (e.pageY - this.offsetTop) - rect.startY ;
					
					ctx.setLineDash([5]);
					ctx.strokeStyle = "rgb(0, 102, 0)";
					ctx.strokeRect(rect.startX, rect.startY, rect.w, rect.h);
					ctx.setLineDash([]);
					ctx.fillStyle = "rgba(0, 255, 0, 0.2)";
					ctx.fillRect(rect.startX, rect.startY, rect.w, rect.h);
				}
			});
		    
		    container.on("mousedown", function(e) {
		    	network.setOptions({ physics: false });
				if (e.button == 2) { 
					selectedNodes = e.ctrlKey ? network.getSelectedNodes() : null;
					saveDrawingSurface();
					var that = this;
					rect.startX = e.pageX - this.offsetLeft;
					rect.startY = e.pageY - this.offsetTop;
					drag = true;
					container[0].style.cursor = "crosshair";
				}
			}); 
			
			container.on("mouseup", function(e) {
				if (e.button == 2) { 
					restoreDrawingSurface();
					drag = false;

					container[0].style.cursor = "default";
					selectNodesFromHighlight();
				}
		    	network.setOptions({ physics: true });
		    	e.stopPropagation();
			});

			$(document).keyup(function(e) {
				if (e.keyCode == 46) { // delete button pressed
					removeSelectedNodes();
				}
			})
		}

		var network, nodes, edges;
		var container = $("#network");
		var canvas;
		var ctx;
		var rect = {}, drag = false;
		var drawingSurfaceImageData;

		$(document).ready(function() {
			var dsInputView = new DsInputView();
			
			registerListeners();
		});
	</script>
</body>
</html>
